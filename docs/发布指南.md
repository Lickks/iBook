# iBook 发布指南

本文档说明如何打包和发布 iBook 应用。

## 前置准备

### 1. 环境要求
- Node.js v18.0+ (推荐 LTS 版本)
- npm 或 pnpm
- Git
- GitHub 账号和仓库访问权限

### 2. 配置检查

#### 更新 electron-builder.yml
确保以下配置正确：
- `appId`: `com.ibook.app`
- `productName`: `iBook`
- `publish.provider`: `github`
- `publish.owner`: 你的 GitHub 用户名
- `publish.repo`: `ibook`（或你的仓库名）

#### 更新 package.json
确保以下字段正确：
- `name`: `ibook`
- `version`: 版本号（如 `1.0.0`）
- `author`: 你的信息
- `homepage`: GitHub 仓库地址

#### 更新 dev-app-update.yml
确保以下配置正确：
- `provider`: `github`
- `owner`: 你的 GitHub 用户名
- `repo`: `ibook`（或你的仓库名）

### 3. GitHub Token 配置

为了自动上传到 GitHub Releases，需要配置 GitHub Personal Access Token：

1. 访问 GitHub Settings > Developer settings > Personal access tokens > Tokens (classic)
2. 创建新 Token，勾选 `repo` 权限
3. 复制 Token
4. 设置环境变量：
   ```bash
   # Windows (PowerShell)
   $env:GH_TOKEN="your-token-here"
   
   # macOS/Linux
   export GH_TOKEN="your-token-here"
   ```

或者使用 `.env` 文件（需要安装 `dotenv`）：
```
GH_TOKEN=your-token-here
```

## 打包流程

### 1. 更新版本号

在 `package.json` 中更新版本号：
```json
{
  "version": "1.0.0"
}
```

### 2. 构建应用

#### Windows
```bash
npm run build:win
```

#### macOS
```bash
npm run build:mac
```

#### Linux
```bash
npm run build:linux
```

### 3. 打包输出

打包完成后，安装包会生成在 `dist/` 目录下：
- Windows: `iBook-1.0.0-setup.exe`
- macOS: `iBook-1.0.0.dmg`
- Linux: `iBook-1.0.0.AppImage`, `iBook-1.0.0.deb`, `iBook-1.0.0.snap`

## 发布到 GitHub Releases

### 方式一：使用 electron-builder 自动发布（推荐）

electron-builder 可以自动创建 GitHub Release 并上传文件：

```bash
# Windows
GH_TOKEN=your-token npm run build:win -- --publish always

# macOS
GH_TOKEN=your-token npm run build:mac -- --publish always

# Linux
GH_TOKEN=your-token npm run build:linux -- --publish always
```

**注意**：`--publish always` 会：
1. 自动创建 GitHub Release（如果不存在）
2. 上传所有构建产物
3. 生成 `latest.yml`、`latest-mac.yml` 等更新清单文件

### 方式二：手动创建 GitHub Release

如果自动发布失败，可以手动创建：

1. **创建 Release**
   - 访问 GitHub 仓库
   - 点击 "Releases" > "Draft a new release"
   - 填写版本号（如 `v1.0.0`）
   - 填写 Release 标题和描述
   - 点击 "Publish release"

2. **上传文件**
   - 在 Release 页面点击 "Edit"
   - 拖拽安装包文件到 "Attach binaries" 区域
   - 上传所有平台的安装包
   - 保存更改

3. **生成更新清单文件**
   
   需要手动创建或使用工具生成 `latest.yml` 等文件。这些文件用于自动更新功能。

   **Windows (latest.yml)**:
   ```yaml
   version: 1.0.0
   files:
     - url: iBook-1.0.0-setup.exe
       sha512: <file-hash>
       size: <file-size>
   path: iBook-1.0.0-setup.exe
   sha512: <file-hash>
   releaseDate: '2024-12-XX'
   ```

   **macOS (latest-mac.yml)**:
   ```yaml
   version: 1.0.0
   files:
     - url: iBook-1.0.0.dmg
       sha512: <file-hash>
       size: <file-size>
   path: iBook-1.0.0.dmg
   sha512: <file-hash>
   releaseDate: '2024-12-XX'
   ```

   可以使用以下命令计算文件哈希：
   ```bash
   # Windows (PowerShell)
   Get-FileHash -Path "iBook-1.0.0-setup.exe" -Algorithm SHA512
   
   # macOS/Linux
   shasum -a 512 iBook-1.0.0.dmg
   ```

## Release 说明模板

创建 Release 时，可以使用以下模板：

```markdown
# iBook v1.0.0

## 新功能
- 功能1
- 功能2

## 修复
- 修复1
- 修复2

## 改进
- 改进1
- 改进2

## 安装

### Windows
下载并运行 `iBook-1.0.0-setup.exe`

### macOS
下载并打开 `iBook-1.0.0.dmg`，将应用拖拽到 Applications 文件夹

### Linux
下载 `iBook-1.0.0.AppImage`，添加执行权限后运行：
```bash
chmod +x iBook-1.0.0.AppImage
./iBook-1.0.0.AppImage
```

## 更新日志
详细的更新日志请查看 [CHANGELOG.md](https://github.com/your-username/ibook/blob/main/CHANGELOG.md)

## 相关链接
- [使用手册](https://github.com/your-username/ibook#readme)
- [问题反馈](https://github.com/your-username/ibook/issues)
```

## 自动更新配置

### 更新服务器配置

应用会自动从 GitHub Releases 检查更新。确保：

1. **electron-builder.yml** 中配置了正确的 GitHub 信息：
   ```yaml
   publish:
     provider: github
     owner: your-username
     repo: ibook
   ```

2. **dev-app-update.yml** 中配置了正确的信息：
   ```yaml
   provider: github
   owner: your-username
   repo: ibook
   ```

### 测试自动更新

1. 发布一个测试版本（如 `v1.0.0`）
2. 安装并运行该版本
3. 发布一个更高版本（如 `v1.0.1`）
4. 应用应该自动检测到更新并提示用户

## 常见问题

### Q: 打包失败，提示找不到图标文件
A: 确保 `build/` 目录下存在以下图标文件：
- `icon.ico` (Windows)
- `icon.icns` (macOS)
- `icon.png` (Linux)

### Q: GitHub 自动发布失败
A: 检查：
1. GitHub Token 是否正确配置
2. Token 是否有 `repo` 权限
3. 仓库名称和用户名是否正确

### Q: 自动更新不工作
A: 检查：
1. Release 中是否包含 `latest.yml` 等更新清单文件
2. 更新清单文件中的版本号是否正确
3. 文件哈希值是否正确

### Q: macOS 打包需要代码签名吗？
A: 对于个人使用，可以不签名。但如果要分发，建议进行代码签名和公证（notarization）。

## 后续步骤

1. **推广宣传**
   - 在 README 中添加下载链接
   - 在社交媒体上宣传
   - 提交到应用商店（如需要）

2. **收集反馈**
   - 鼓励用户提交 Issue
   - 收集使用反馈
   - 持续改进

3. **维护更新**
   - 定期发布更新
   - 修复 bug
   - 添加新功能

---

**祝发布顺利！**

