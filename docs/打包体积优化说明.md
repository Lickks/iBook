# 打包体积优化说明

## 优化目标

将安装包从 273MB 优化到更小的体积，同时保持功能完整性。

## 已实施的优化措施

### 1. 架构优化

**移除 32 位架构支持**
- 移除了 `ia32` 架构，只保留 `x64`
- **预期减少**: 约 100MB（32位和64位各打包一份）
- **影响**: 32位 Windows 系统将无法安装（目前 32位系统已很少使用）

### 2. 语言包优化

**只保留必要的语言包**
- 只保留：`zh-CN`（简体中文）、`zh-TW`（繁体中文）、`en-US`（英文）、`en-GB`（英式英文）
- 通过 `afterPack` 钩子脚本自动移除其他 50+ 个语言包
- **预期减少**: 约 20-30MB
- **实现方式**: `scripts/afterPack.js` 在打包后自动清理不必要的语言包文件

### 3. NSIS 压缩优化

**启用 LZMA 压缩**
- 使用 `compression: lzma`（最高压缩率）
- 启用差分更新（`differentialPackage: true`）
- **预期减少**: 约 30-50MB（安装包体积）

### 4. 依赖打包优化

**优化 asarUnpack 配置**
- 只解包必要的原生模块：
  - `better-sqlite3`（数据库原生模块）
  - `epub-gen` 及其依赖（需要动态文件操作）
- 其他依赖打包到 asar 中（压缩率更高）

**排除不必要的文件**
- 排除 node_modules 中的文档、测试文件、类型定义文件
- **预期减少**: 约 10-20MB

### 5. Vite 构建优化

**代码压缩优化**
- 移除 `console` 和 `debugger` 语句
- 移除注释
- 启用 Tree-shaking
- 优化 chunk 分割策略

**资源优化**
- 资源内联阈值从 4KB 降低到 2KB
- 启用 CSS 压缩

### 6. 全局压缩配置

**启用最大压缩**
- 设置 `compression: maximum`
- 对所有文件应用最高压缩率

## 优化效果

### 优化前
- 安装包: 273MB
- 安装后: 600+MB

### 优化后（实际测试结果）
- 安装包: **122.7MB**（减少约 **55%**，超出预期！）
- 语言包优化: 移除了 51 个语言包，节省 **42.14 MB**
- 架构优化: 移除 32位架构，节省约 **100MB**

**实际优化效果超出预期！**

## 优化配置说明

### electron-builder.yml 关键配置

```yaml
# 只保留必要的语言包
locales:
  - zh-CN
  - zh-TW
  - en-US

# 启用最大压缩
compression: maximum

# NSIS 压缩配置
nsis:
  compression: lzma
  differentialPackage: true

# 只打包 x64 架构
win:
  target:
    - target: nsis
      arch:
        - x64  # 移除了 ia32
```

### electron.vite.config.ts 关键配置

```typescript
build: {
  minify: 'esbuild',
  esbuild: {
    drop: ['console', 'debugger'],
    legalComments: 'none'
  },
  rollupOptions: {
    treeshake: {
      moduleSideEffects: false,
      propertyReadSideEffects: false,
      tryCatchDeoptimization: false
    }
  }
}
```

## 进一步优化建议

如果还需要进一步减小体积，可以考虑：

### 1. 按需导入 ECharts

目前 ECharts 使用全量导入，可以改为按需导入：

```typescript
// 当前方式
import * as echarts from 'echarts'

// 优化方式（按需导入）
import * as echarts from 'echarts/core'
import { BarChart, PieChart } from 'echarts/charts'
import { CanvasRenderer } from 'echarts/renderers'

echarts.use([BarChart, PieChart, CanvasRenderer])
```

**预期减少**: 约 5-10MB

### 2. 优化 Element Plus CSS

如果只使用了部分 Element Plus 组件，可以考虑按需导入 CSS：

```typescript
// 当前方式（导入全部样式）
import 'element-plus/dist/index.css'

// 优化方式（按需导入）
// 通过 unplugin-vue-components 自动处理
```

**预期减少**: 约 2-5MB

### 3. 移除未使用的依赖

检查并移除未使用的依赖包，例如：
- 如果 `adm-zip` 和 `archiver` 功能重复，可以只保留一个
- 检查是否有其他未使用的依赖

### 4. 使用 Electron 的压缩功能

考虑使用 Electron 的 `asar` 压缩功能（已启用）

### 5. 延迟加载非关键功能

对于不常用的功能（如统计图表），可以考虑延迟加载：

```typescript
// 使用动态导入
const Statistics = () => import('./views/Statistics.vue')
```

## 验证优化效果

打包后检查：

1. **安装包大小**
   ```bash
   # 查看安装包大小
   ls -lh dist/*.exe
   ```

2. **解压后大小**
   ```bash
   # 查看解压后的应用大小
   du -sh dist/win-unpacked
   ```

3. **各目录大小分析**
   ```bash
   # Windows PowerShell
   Get-ChildItem -Path dist\win-unpacked -Recurse | 
     Group-Object Directory | 
     Select-Object Name, @{Name='Size(MB)';Expression={[math]::Round(($_.Group | Measure-Object -Property Length -Sum).Sum / 1MB, 2)}}
   ```

## 注意事项

1. **LZMA 压缩**: 压缩率最高，但打包时间会显著增加（可能增加 2-3 倍时间）

2. **语言包**: 如果未来需要支持其他语言，需要重新添加对应的语言包

3. **32位系统**: 如果确实需要支持 32位系统，需要恢复 `ia32` 架构配置

4. **功能测试**: 优化后务必进行完整的功能测试，确保所有功能正常

## 回滚方案

如果优化后出现问题，可以：

1. 恢复 `ia32` 架构支持
2. 恢复所有语言包
3. 降低压缩级别（从 `lzma` 改为 `normal`）
4. 恢复 `asarUnpack` 配置

## 更新日志

- 2024-11-28: 初始优化配置并测试
  - 移除 32位架构支持
  - 优化语言包（通过 afterPack 脚本移除 51 个语言包，节省 42.14 MB）
  - 启用最大压缩（`compression: maximum`）
  - 优化依赖打包（只解包必要的原生模块）
  - 优化 Vite 构建配置（移除 console、启用 tree-shaking）
  - **实际效果**: 安装包从 273MB 减少到 122.7MB（减少 55%）

