# 项目结构说明

## 📁 完整目录结构

```
book-store/                              # 项目根目录
│
├── src/                                # 源代码目录
│   │
│   ├── main/                           # ✅ Electron 主进程代码
│   │   ├── index.ts                    # ⭐ 主进程入口，创建窗口、初始化数据库
│   │   │
│   │   ├── ipc/                        # ✅ IPC 通信处理器
│   │   │   ├── bookHandler.ts          # ⭐ 书籍操作的 IPC 处理
│   │   │   ├── documentHandler.ts      # ⭐ 文档操作的 IPC 处理
│   │   │   ├── searchHandler.ts        # ⭐ 搜索操作的 IPC 处理
│   │   │   ├── statsHandler.ts         # ⭐ 统计操作的 IPC 处理
│   │   │   └── tagHandler.ts           # ⭐ 标签操作的 IPC 处理（阶段十一新增）
│   │   │
│   │   └── services/                   # ✅ 主进程业务服务
│   │       ├── database.ts             # ⭐ 数据库服务（SQLite CRUD）
│   │       ├── spider.ts               # ⭐ 爬虫服务（youshu.me）
│   │       ├── fileManager.ts          # ⭐ 文件管理服务
│   │       ├── wordCounter.ts          # ⭐ 字数统计服务
│   │       ├── cover.ts                 # ⭐ 封面下载服务
│   │       └── windowState.ts           # ⭐ 窗口状态管理服务（阶段十三新增）
│   │
│   ├── preload/                        # ✅ Electron 预加载脚本
│   │   ├── index.ts                    # ⭐ 暴露安全的 API 给渲染进程
│   │   └── index.d.ts                  # ⭐ TypeScript 类型声明
│   │
│   └── renderer/                       # ✅ Vue 渲染进程代码
│       ├── index.html                  # HTML 入口文件
│       ├── auto-imports.d.ts           # 自动导入类型声明
│       ├── components.d.ts             # 组件类型声明
│       │
│       └── src/                        # Vue 应用源码
│           ├── main.ts                 # ⭐ Vue 应用入口
│           ├── App.vue                 # ⭐ 根组件，包含布局
│           │
│           ├── router/                 # ✅ Vue Router 路由配置
│           │   └── index.ts            # ⭐ 路由定义（含标签管理路由）
│           │
│           ├── stores/                 # ✅ Pinia 状态管理
│           │   ├── index.ts            # Pinia 实例导出
│           │   ├── book.ts             # ⭐ 书籍状态（books, currentBook, 筛选排序）
│           │   ├── ui.ts               # ⭐ UI 状态（主题、布局）
│           │   ├── stats.ts            # ⭐ 统计数据状态
│           │   ├── displayMode.ts      # ⭐ 显示模式状态（简约/经典，支持持久化）
│           │   └── tag.ts              # ⭐ 标签状态（tags, loading）（阶段十一新增）
│           │
│           ├── views/                  # ✅ 页面组件（路由级）
│           │   ├── Home.vue            # ⭐ 首页 - 书籍列表（含筛选和批量操作）
│           │   ├── BookDetail.vue      # ⭐ 书籍详情页（含标签管理）
│           │   ├── AddBook.vue         # ⭐ 添加书籍页（含标签选择）
│           │   ├── Statistics.vue      # ⭐ 统计分析页
│           │   ├── Settings.vue        # ⭐ 设置页
│           │   └── TagManagement.vue   # ⭐ 标签管理页面（阶段十一新增）
│           │
│           ├── components/             # ✅ 通用组件
│           │   ├── BookCard.vue        # ⭐ 书籍卡片（网格视图，含标签展示）
│           │   ├── BookForm.vue        # ⭐ 书籍表单（添加/编辑）
│           │   ├── SearchBar.vue       # ⭐ 搜索栏
│           │   ├── NetworkSearch.vue   # ⭐ 网络检索组件
│           │   ├── DisplayModeToggle.vue # ⭐ 视图切换组件
│           │   ├── StatusFilter.vue    # ⭐ 状态筛选组件（已废弃）
│           │   ├── StatusStats.vue     # ⭐ 状态统计展示
│           │   ├── FilterBar.vue       # ⭐ 筛选工具栏（类型/平台/标签/排序）（阶段十一新增）
│           │   ├── TagList.vue         # ⭐ 标签列表展示组件（阶段十一新增）
│           │   ├── TagSelector.vue     # ⭐ 标签选择器组件（阶段十一新增）
│           │   ├── ThemeSelector.vue   # ⭐ 主题选择器组件（阶段十三新增）
│           │   ├── LoadingSpinner.vue  # ⭐ 统一加载动画组件（阶段十三新增）
│           │   ├── SkeletonLoader.vue  # ⭐ 骨架屏组件（阶段十三新增）
│           │   ├── Versions.vue        # 版本信息组件
│           │   │
│           │   └── stats/              # 统计相关组件
│           │       └── BaseChart.vue   # ⭐ 图表基类组件（ECharts 封装）
│           │
│           ├── api/                    # ✅ API 接口层（调用 Electron API）
│           │   ├── book.ts             # ⭐ 书籍 API（含批量删除）
│           │   ├── document.ts         # ⭐ 文档 API
│           │   ├── search.ts           # ⭐ 搜索 API
│           │   ├── stats.ts            # ⭐ 统计 API
│           │   └── tag.ts              # ⭐ 标签 API（阶段十一新增）
│           │
│           ├── types/                  # ✅ TypeScript 类型定义
│           │   ├── index.ts            # 统一导出所有类型
│           │   ├── book.ts             # ⭐ Book 相关类型（含Tag类型）
│           │   └── api.ts              # ⭐ API 响应类型
│           │
│           ├── utils/                  # ✅ 工具函数
│           │   ├── index.ts            # 统一导出工具函数
│           │   └── format.ts           # ⭐ 格式化函数（日期、数字、字数）
│           │
│           ├── constants/              # ✅ 常量定义
│           │   └── index.ts            # ⭐ 导出所有常量（阅读状态、字数来源、排序选项、标签颜色等）
│           │
│           └── assets/                 # ✅ 静态资源
│               ├── base.css            # 基础样式
│               ├── main.css            # 主样式
│               ├── electron.svg        # Electron 图标
│               └── wavy-lines.svg      # 装饰图案
│
├── database/                           # ✅ 数据库相关
│   ├── schema.sql                      # ⭐ 数据库结构定义
│   ├── ibook.db                        # SQLite 数据库文件（开发环境）
│   └── migrations/                     # 数据库迁移脚本目录（预留）
│
├── docs/                               # ✅ 项目文档
│   ├── 需求分析文档.md                 # ⭐ 详细需求分析
│   ├── 技术选型与架构设计.md           # ⭐ 技术栈和架构
│   ├── 快速启动指南.md                 # ⭐ 开发环境搭建
│   ├── 补充功能与设计说明.md           # ⭐ 补充功能和边界场景
│   ├── 开发任务清单.md                 # ⭐ 详细的开发任务
│   ├── 项目结构说明.md                 # ⭐ 本文件
│   └── 完成情况总结.md                 # ⭐ 项目完成情况总结
│
├── build/                              # 构建资源
│   ├── icon.icns                       # macOS 图标
│   ├── icon.ico                        # Windows 图标
│   ├── icon.png                        # 通用图标
│   └── entitlements.mac.plist          # macOS 权限配置
│
├── resources/                          # 资源文件
│   └── icon.png                        # 应用图标
│
├── out/                                # 构建输出目录（开发环境）
│   ├── main/                           # 主进程构建产物
│   └── preload/                        # 预加载脚本构建产物
│
├── public/                             # 公共资源（不会被打包处理）
│
├── node_modules/                       # 依赖包目录
│
├── .gitignore                          # ⭐ Git 忽略文件
├── electron.vite.config.ts             # ⭐ Electron + Vite 配置
├── electron-builder.yml                # ⭐ Electron Builder 打包配置
├── eslint.config.mjs                   # ⭐ ESLint 配置
├── package.json                        # ⭐ 项目配置和依赖
├── package-lock.json                   # npm 锁定文件
├── pnpm-lock.yaml                      # pnpm 锁定文件
├── tsconfig.json                       # ⭐ TypeScript 配置
├── tsconfig.node.json                  # Node.js 环境 TS 配置
├── tsconfig.web.json                   # Web 环境 TS 配置
├── dev-app-update.yml                  # 开发环境更新配置
├── README.md                           # ⭐ 项目说明
└── LICENSE                             # 开源协议（如果有）
```

---

## 📝 核心文件说明

### 主进程（Electron）

#### `src/main/index.ts` ✅ 已完成
- **作用**: Electron 应用的入口
- **职责**:
  - 创建主窗口（已优化配置）
  - 初始化数据库（app.whenReady 时）
  - 注册所有 IPC 处理器
  - 管理应用生命周期
  - 关闭时断开数据库连接

#### `src/preload/index.ts` ✅ 已完成
- **作用**: 渲染进程与主进程的桥梁
- **职责**:
  - 通过 `contextBridge` 暴露安全的 API
  - 暴露 book、document、search、stats 相关 API
  - 提供 TypeScript 类型定义（index.d.ts）
  - 隔离渲染进程和 Node.js 环境

#### `src/main/services/database.ts` ✅ 已完成
- **作用**: 数据库操作封装
- **职责**:
  - SQLite 连接管理（better-sqlite3）
  - 数据库初始化（读取并执行 schema.sql）
  - 书籍 CRUD 操作
  - 文档 CRUD 操作
  - 笔记 CRUD 操作（已实现，暂未使用）
  - 标签 CRUD 操作（已实现，暂未使用）
  - 阅读进度 CRUD 操作（已实现，暂未使用）
  - 统一错误处理

#### `src/main/services/spider.ts` ✅ 已完成
- **作用**: 网络爬虫服务
- **职责**:
  - 从 youshu.me 检索书籍信息
  - 解析 HTML 页面（cheerio）
  - 提取书籍数据（书名、作者、封面、字数、平台、描述）
  - 错误处理（超时、网络错误）

#### `src/main/services/fileManager.ts` ✅ 已完成
- **作用**: 文件管理服务
- **职责**:
  - 文件保存（UUID 命名，复制到指定目录）
  - 文件删除（物理删除）
  - 文件打开（使用系统默认程序，shell.openPath）
  - 文件路径管理（getFilePath、getFileSize）
  - 目录管理（自动创建 documents 目录）
- **存储位置**: `{userData}/documents/`
- **命名规则**: `{bookId}_{uuid}.{extension}`

#### `src/main/services/wordCounter.ts` ✅ 已完成
- **作用**: 文档字数统计
- **职责**:
  - 支持多种格式（TXT, EPUB, PDF, DOCX）
  - TXT: 编码检测（jschardet） + 解码（iconv-lite）
  - EPUB: 章节提取（epub 库）
  - PDF: 文本提取（pdf-parse）
  - DOCX: 文本提取（mammoth）
  - 混合字数计算（中文字符数 + 英文单词数）
  - 统一错误处理和格式化

#### `src/main/services/cover.ts` ✅ 已完成
- **作用**: 封面下载服务
- **职责**:
  - 从网络 URL 下载封面图片
  - 图片格式转换
  - 图片压缩
  - 保存到本地（userData/covers/）

#### `src/main/services/windowState.ts` ✅ 已完成（阶段十三）
- **作用**: 窗口状态管理服务
- **职责**:
  - 保存窗口大小、位置和最大化状态
  - 从localStorage恢复窗口状态
  - 使用防抖机制优化保存性能
  - 确保窗口位置在屏幕范围内
  - 支持多显示器环境

---

### 渲染进程（Vue）

#### `src/renderer/src/main.ts` ✅ 已完成（阶段十三完善）
- **作用**: Vue 应用入口
- **职责**:
  - 创建 Vue 应用实例
  - 注册路由、状态管理（Pinia）
  - 导入 Element Plus 样式和暗色主题CSS
  - 初始化主题设置
  - 挂载应用

#### `src/renderer/src/App.vue` ✅ 已完成（阶段十三完善）
- **作用**: 根组件
- **职责**:
  - 应用整体布局（响应式侧边栏、顶部导航）
  - 路由出口 `<router-view>`（含过渡动画）
  - 主题管理（明暗主题切换）

#### `src/renderer/src/router/index.ts` ✅ 已完成
- **作用**: 路由配置
- **职责**:
  - 定义路由规则（Home、BookDetail、AddBook、Statistics、Settings）
  - 路由懒加载
  - 路由守卫（如有需要）

#### `src/stores/book.ts` ✅ 已完成
- **作用**: 书籍状态管理
- **职责**:
  - 管理书籍列表（books）
  - 管理当前书籍（currentBook）
  - 管理搜索关键词（searchKeyword）
  - 管理选中状态（selectedStatus）
  - 管理加载状态（loading）
  - 提供筛选后的书籍列表（filteredBooks）
  - 提供状态统计（statusStats）
  - 支持批量状态更新（batchUpdateStatus）
  - 提供所有 CRUD 操作
  - 与 API 层交互

#### `src/stores/ui.ts` ✅ 已完成
- **作用**: UI 状态管理
- **职责**:
  - 主题管理（theme: 'light' | 'dark' | 'auto'）
  - 视图模式（viewMode: 'grid' | 'list'）
  - 侧边栏状态（sidebarCollapsed）
  - 主题持久化（localStorage）
  - 跟随系统主题

#### `src/stores/displayMode.ts` ✅ 已完成（阶段十三完善）
- **作用**: 显示模式状态管理
- **职责**:
  - 显示模式管理（displayMode: 'simple' | 'classic'）
  - 状态持久化（localStorage）
  - 简约/经典模式切换

#### `src/stores/stats.ts` ✅ 已完成
- **作用**: 统计数据状态管理
- **职责**:
  - 基于 book store 计算统计数据
  - 提供各种统计 getters

#### `src/api/book.ts` ✅ 已完成
- **作用**: 书籍 API 封装
- **职责**:
  - 调用 `window.electronAPI.book.*`
  - 统一错误处理
  - 数据转换（snake_case ↔ camelCase）

#### `src/api/document.ts` ✅ 已完成
- **作用**: 文档 API 封装
- **职责**:
  - 调用 `window.electronAPI.document.*`
  - 文档上传、删除、打开、字数统计等

#### `src/api/search.ts` ✅ 已完成
- **作用**: 搜索 API 封装
- **职责**:
  - 调用 `window.electronAPI.search.youshu`
  - 网络检索功能

#### `src/api/stats.ts` ✅ 已完成
- **作用**: 统计 API 封装
- **职责**:
  - 调用 `window.electronAPI.stats.*`
  - 各种统计数据获取

---

### 视图组件

#### `src/components/stats/StatusStats.vue` ✅ 已完成
- **作用**: 阅读状态统计展示组件
- **功能**:
  - 显示各状态下的书籍数量统计
  - 点击统计卡片可快速筛选对应状态
  - 网格布局适配不同屏幕尺寸
  - 视觉反馈显示当前选中状态
  - 5种状态：未读、阅读中、已读完、弃读、待读

#### `src/views/Home.vue` ✅ 已完成
- **作用**: 首页 - 书籍列表
- **功能**:
  - 展示所有书籍（网格/列表视图）
  - 搜索和关键词筛选（防抖搜索）
  - 状态统计展示（StatusStats 组件）
  - 状态筛选（点击状态卡片）
  - 清空筛选条件
  - 视图切换（DisplayModeToggle）
  - 批量选择（Checkbox）
  - 批量删除
  - 批量状态更新
  - 加载状态和空状态提示

#### `src/views/BookDetail.vue` ✅ 已完成
- **作用**: 书籍详情页
- **功能**:
  - 展示完整书籍信息（封面、元数据、简介）
  - **文档管理**（✅ 阶段七已完成）
    - 上传文档（TXT/EPUB/PDF/DOCX）
    - 文档列表展示（文件名、类型、大小、字数、上传时间）
    - 文档操作：打开、重新统计字数、删除
    - 加载状态和空状态
  - **字数来源选择**（✅ 阶段七已完成）
    - 三个来源：手动输入、网络检索、文档统计
    - 可随时切换字数来源（点击切换）
    - Active 状态视觉反馈
    - 显示当前使用的字数
  - 编辑模式（复用 BookForm 组件）
  - 删除确认对话框

#### `src/views/AddBook.vue` ✅ 已完成
- **作用**: 添加书籍页
- **功能**:
  - **网络检索**（Tab 1）
    - 输入书名/作者搜索
    - 展示搜索结果列表
    - 选择结果并导入
    - 加载状态和错误提示
  - **手动添加**（Tab 2）
    - 使用 BookForm 组件
    - 表单验证
    - 封面上传/链接
    - 提交处理

#### `src/views/Statistics.vue` ✅ 已完成
- **作用**: 统计分析页面
- **功能**:
  - 总体统计（6个核心指标卡片）
    - 总书籍数
    - 总字数
    - 已读完数量
    - 阅读中数量
    - 平均评分
    - 其他统计
  - 数据可视化（5个图表）
    - 类型分布（饼图）
    - 平台分布（饼图）
    - 月度趋势（折线图）
    - 阅读状态分布（柱状图）
    - 其他图表
  - 响应式布局

---

### 通用组件

#### `src/components/BookCard.vue` ✅ 已完成
- **作用**: 书籍卡片（网格视图）
- **展示**:
  - 封面（支持占位图）
  - 书名、作者
  - 字数、评分
  - 阅读状态标签（可点击）
- **功能**:
  - 点击状态徽章快速切换阅读状态
  - 支持下拉菜单选择5种状态（未读、阅读中、已读完、弃读、待读）
  - 状态更新成功提示
  - 搜索关键字高亮
  - 悬浮交互效果

#### `src/renderer/src/components/BookForm.vue` ✅ 已完成
- **作用**: 书籍表单
- **功能**:
  - 所有字段的输入（书名、作者、封面、平台、类型、描述、字数等）
  - 封面上传/链接
  - 字数来源选择
  - 字段验证
  - 支持编辑模式

#### `src/renderer/src/components/NetworkSearch.vue` ✅ 已完成
- **作用**: 网络检索组件
- **功能**:
  - 输入书名/作者搜索
  - 展示搜索结果列表
  - 选择结果并导入
  - 加载状态和错误提示

#### `src/renderer/src/components/DisplayModeToggle.vue` ✅ 已完成

#### `src/renderer/src/components/ThemeSelector.vue` ✅ 已完成（阶段十三）
- **作用**: 主题选择器组件
- **职责**:
  - 提供明亮/暗黑/跟随系统三种主题选择
  - 显示当前选中的主题状态
  - 美观的UI设计和交互反馈
  - 集成到设置页面

#### `src/renderer/src/components/LoadingSpinner.vue` ✅ 已完成（阶段十三）
- **作用**: 统一加载动画组件
- **职责**:
  - 支持小/中/大三种尺寸
  - 支持全屏遮罩模式
  - 流畅的旋转动画效果
  - 可选的加载文本提示

#### `src/renderer/src/components/SkeletonLoader.vue` ✅ 已完成（阶段十三）
- **作用**: 骨架屏组件
- **职责**:
  - 书籍卡片骨架屏
  - 列表项骨架屏
  - 文本骨架屏（可配置行数）
  - 流畅的加载动画
  - 在Home.vue和TagManagement.vue中使用
- **作用**: 视图切换组件
- **功能**:
  - 网格/列表视图切换
  - 状态持久化

---

## 🗂️ 数据流向

### 添加书籍流程

```
User Action (AddBook.vue)
    ↓
Button Click
    ↓
Call bookStore.createBook(data)
    ↓
bookStore (Pinia Store)
    ↓
Call bookAPI.create(data)
    ↓
bookAPI (src/api/book.ts)
    ↓
window.electronAPI.book.create(data)
    ↓
IPC (electron/preload.ts)
    ↓
bookHandler (electron/ipc/bookHandler.ts)
    ↓
database.createBook(data) (electron/services/database.ts)
    ↓
SQLite (userData/ibook.db)
    ↓
Return Book Object
    ↓
Update Pinia Store
    ↓
Re-render UI
```

### 文档上传流程 ⭐ 阶段七已完成

```
User Action (BookDetail.vue)
    ↓
Click "上传文档" Button
    ↓
Call window.api.document.selectFile()
    ↓
IPC → documentHandler → dialog.showOpenDialog()
    ↓
User selects file
    ↓
Call window.api.document.upload(filePath, bookId)
    ↓
IPC (electron/preload.ts)
    ↓
documentHandler (electron/ipc/documentHandler.ts)
    ↓
fileManager.saveFile(filePath, bookId)
    ├─ Copy file to userData/documents/
    └─ Return: {bookId}_{uuid}.{ext}
    ↓
wordCounter.countWords(savedFilePath)
    ├─ Detect file type (.txt/.epub/.pdf/.docx)
    ├─ Extract text content
    └─ Calculate word count (Chinese chars + English words)
    ↓
database.createDocument(documentInput)
    └─ Insert into documents table
    ↓
Return Document Object
    ↓
Update UI (documents list + word count)
    ↓
Show confirmation dialog
    └─ "是否使用文档字数作为书籍字数？"
```

### 阅读状态管理流程 ⭐ 阶段八8.3已完成

```
用户操作流程：

1. 状态统计筛选：
   User clicks status card in StatusStats
   ↓
   Call handleStatusClick(status)
   ↓
   bookStore.setSelectedStatus(status)
   ↓
   Update filteredBooks computed property
   ↓
   Re-render book list with filtered results

2. 快捷状态切换：
   User clicks status badge on BookCard
   ↓
   Show status dropdown menu
   ↓
   User selects new status
   ↓
   Call updateReadingStatus(status)
   ↓
   bookStore.updateBook(bookId, { readingStatus: status })
   ↓
   IPC → bookHandler → database.updateBook()
   ↓
   Update local book state
   ↓
   Update status display + Show success message
```

---

## 📦 打包后的目录结构

```
release/
├── win-unpacked/                    # Windows 未打包版本（绿色版）
│   ├── iBook.exe
│   ├── resources/
│   └── ...
│
└── iBook Setup 1.0.0.exe           # Windows 安装包
```

**用户数据目录** (Windows):
```
C:/Users/{username}/AppData/Roaming/iBook/
├── ibook.db                        # SQLite 数据库
├── documents/                      # 上传的文档
│   ├── 1_uuid.txt
│   ├── 2_uuid.epub
│   └── ...
├── covers/                         # 下载的封面
│   ├── 1.jpg
│   ├── 2.jpg
│   └── ...
└── backups/                        # 备份文件
    ├── backup_20240101.json
    ├── backup_20240108.json
    └── ...
```

---

## 🎯 关键技术点

### 主进程与渲染进程通信

**为什么分离？**
- **安全性**: 渲染进程不能直接访问 Node.js API
- **性能**: 主进程处理耗时操作，不阻塞 UI
- **架构清晰**: 职责分离

**如何通信？**
- 通过 IPC (Inter-Process Communication)
- `ipcMain` (主进程) 和 `ipcRenderer` (渲染进程)
- `contextBridge` 暴露安全的 API

### 数据持久化

**为什么用 SQLite？**
- 轻量级，无需安装
- 支持 SQL 查询
- 单文件，易于备份
- 性能优秀

**数据安全：**
- 定期自动备份
- 支持手动导出
- WAL 模式防止损坏

### 状态管理

**为什么用 Pinia？**
- Vue 3 官方推荐
- TypeScript 支持好
- API 简洁
- 模块化

---

## 🚀 开发建议

### 1. 按模块开发

不要试图一次性完成所有功能，按模块逐步开发：
1. 数据库 → 主进程 → IPC → 前端 API → UI
2. 先实现基础功能，再添加高级功能

### 2. 关注点分离

- **主进程**: 数据、文件、网络（重逻辑）
- **渲染进程**: 展示、交互（重视图）
- **API 层**: 作为主进程和 UI 的桥梁

### 3. 类型安全

充分利用 TypeScript：
- 定义清晰的接口
- 避免使用 `any`
- 使用泛型

### 4. 错误处理

每一层都要处理错误：
- 主进程：捕获异常，记录日志
- IPC：返回错误信息
- API 层：统一错误处理
- UI：友好的错误提示

---

## 📚 参考资源

- **Electron 官方文档**: https://www.electronjs.org/docs
- **Vue 3 文档**: https://vuejs.org/
- **Pinia 文档**: https://pinia.vuejs.org/
- **Element Plus 文档**: https://element-plus.org/
- **Better SQLite3**: https://github.com/WiseLibs/better-sqlite3

---

希望这份结构说明能帮助你快速理解项目！🎉

