<template>
  <div class="statistics">
    <!-- 页面标题和操作区 -->
    <div class="statistics__header">
      <div class="statistics__title">
        <h1>统计分析</h1>
        <p class="statistics__subtitle">查看您的阅读数据和统计信息</p>
      </div>
      <div class="statistics__actions">
        <el-button-group>
          <el-button
            type="primary"
            :icon="Download"
            @click="showExportDialog = true"
          >
            导出数据
          </el-button>
          <el-button
            :icon="Refresh"
            @click="refreshData"
            :loading="loading"
          >
            刷新
          </el-button>
        </el-button-group>
      </div>
    </div>

    <!-- 加载状态 -->
    <div v-if="loading" class="statistics__loading">
      <el-skeleton :rows="8" animated />
    </div>

    <!-- 统计内容 -->
    <div v-else-if="statisticsData" class="statistics__content">
      <!-- 总体统计卡片 -->
      <div class="statistics__overview">
        <StatCard
          title="总书籍数"
          :value="statisticsData.totalBooks"
          unit="本"
          icon="Document"
          :loading="loading"
          theme="primary"
        />
        <StatCard
          title="总字数"
          :value="statisticsData.totalWordCount"
          unit="字"
          icon="Reading"
          :loading="loading"
          theme="success"
          format="wordCount"
        />
        <StatCard
          title="平均评分"
          :value="statisticsData.averageRating"
          unit="分"
          icon="Star"
          :loading="loading"
          theme="warning"
        />
        <StatCard
          title="已读完"
          :value="statisticsData.finishedBooks"
          unit="本"
          icon="Trophy"
          :loading="loading"
          theme="success"
        />
        <StatCard
          title="阅读中"
          :value="statisticsData.readingBooks"
          unit="本"
          icon="Clock"
          :loading="loading"
          theme="primary"
        />
        <StatCard
          title="未读"
          :value="statisticsData.unreadBooks"
          unit="本"
          icon="Document"
          :loading="loading"
          theme="info"
        />
      </div>

      <!-- 图表区域 -->
      <div class="statistics__charts">
        <!-- 第一行图表 -->
        <div class="statistics__chart-row">
          <!-- 类型分布饼图 -->
          <div class="statistics__chart-item">
            <PieChart
              :data="statisticsData.categoryStats"
              :loading="loading"
              height="350px"
              title="书籍类型分布"
              :show-legend="true"
              legend-position="bottom"
              @slice-click="handleCategoryClick"
            />
          </div>

          <!-- 平台分布饼图 -->
          <div class="statistics__chart-item">
            <PieChart
              :data="statisticsData.platformStats"
              :loading="loading"
              height="350px"
              title="阅读平台分布"
              :show-legend="true"
              legend-position="bottom"
              @slice-click="handlePlatformClick"
            />
          </div>

          <!-- 阅读状态分布饼图 -->
          <div class="statistics__chart-item">
            <PieChart
              :data="statisticsData.statusStats"
              :loading="loading"
              height="350px"
              title="阅读状态分布"
              :show-legend="true"
              legend-position="bottom"
              @slice-click="handleStatusClick"
            />
          </div>
        </div>

        <!-- 第二行图表 - 月度趋势 -->
        <div class="statistics__chart-row">
          <div class="statistics__chart-item statistics__chart-item--full">
            <LineChart
              :data="statisticsData.monthlyStats.books"
              :loading="loading"
              height="400px"
              title="月度新增书籍趋势"
              :show-legend="true"
              legend-position="top"
              :smooth="true"
              :show-area="false"
              @data-point-click="handleMonthClick"
            />
          </div>
        </div>

        <!-- 第三行图表 - 月度字数统计 -->
        <div class="statistics__chart-row">
          <div class="statistics__chart-item statistics__chart-item--full">
            <BarChart
              :data="statisticsData.monthlyStats.words"
              :loading="loading"
              height="400px"
              title="月度新增字数统计"
              :show-legend="true"
              legend-position="top"
              direction="vertical"
              :bar-width="'60%'"
              @bar-click="handleWordCountClick"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- 空状态 -->
    <div v-else class="statistics__empty">
      <el-empty
        description="暂无统计数据"
        :image-size="200"
      >
        <template #description>
          <p>您还没有添加任何书籍</p>
          <p class="statistics__empty-tip">添加书籍后即可查看详细的统计信息</p>
        </template>
        <el-button type="primary" @click="$router.push('/add')">
          添加书籍
        </el-button>
      </el-empty>
    </div>

    <!-- 导出对话框 -->
    <el-dialog
      v-model="showExportDialog"
      title="导出数据"
      width="500px"
    >
      <div class="export-dialog__content">
        <el-form :model="exportForm" label-width="100px">
          <el-form-item label="导出格式">
            <el-radio-group v-model="exportForm.format">
              <el-radio label="excel">Excel 文件</el-radio>
              <el-radio label="csv">CSV 文件</el-radio>
            </el-radio-group>
          </el-form-item>

          <el-form-item label="数据范围">
            <el-checkbox-group v-model="exportForm.dataTypes">
              <el-checkbox label="books">书籍信息</el-checkbox>
              <el-checkbox label="statistics">统计数据</el-checkbox>
              <el-checkbox label="charts">图表数据</el-checkbox>
            </el-checkbox-group>
          </el-form-item>

          <el-form-item label="时间范围">
            <el-date-picker
              v-model="exportForm.dateRange"
              type="daterange"
              range-separator="至"
              start-placeholder="开始日期"
              end-placeholder="结束日期"
              :shortcuts="dateShortcuts"
              value-format="YYYY-MM-DD"
            />
          </el-form-item>
        </el-form>
      </div>

      <template #footer>
        <div class="export-dialog__footer">
          <el-button @click="showExportDialog = false">取消</el-button>
          <el-button
            type="primary"
            @click="handleExport"
            :loading="exporting"
          >
            {{ exporting ? '导出中...' : '导出' }}
          </el-button>
        </div>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, reactive } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { Download, Refresh } from '@element-plus/icons-vue'
import StatCard from '@/components/stats/StatCard.vue'
import PieChart from '@/components/stats/PieChart.vue'
import LineChart from '@/components/stats/LineChart.vue'
import BarChart from '@/components/stats/BarChart.vue'
import statsApi from '@/api/stats'
import type { StatisticsData, ChartData, MonthlyData } from '@/api/stats'

// 响应式数据
const loading = ref(false)
const exporting = ref(false)
const showExportDialog = ref(false)
const statisticsData = ref<StatisticsData>()

// 导出表单
const exportForm = reactive({
  format: 'excel' as 'excel' | 'csv',
  dataTypes: ['books', 'statistics'] as string[],
  dateRange: [] as string[]
})

// 日期快捷选项
const dateShortcuts = [
  {
    text: '最近一周',
    value: () => {
      const end = new Date()
      const start = new Date()
      start.setTime(start.getTime() - 3600 * 1000 * 24 * 7)
      return [start, end]
    }
  },
  {
    text: '最近一个月',
    value: () => {
      const end = new Date()
      const start = new Date()
      start.setTime(start.getTime() - 3600 * 1000 * 24 * 30)
      return [start, end]
    }
  },
  {
    text: '最近三个月',
    value: () => {
      const end = new Date()
      const start = new Date()
      start.setTime(start.getTime() - 3600 * 1000 * 24 * 90)
      return [start, end]
    }
  }
]

// 获取统计数据
const fetchStatistics = async () => {
  loading.value = true
  try {
    const response = await statsApi.getOverview()
    if (response.success && response.data) {
      statisticsData.value = response.data
    } else {
      ElMessage.error(response.error || '获取统计数据失败')
    }
  } catch (error) {
    console.error('获取统计数据失败:', error)
    ElMessage.error('获取统计数据失败')
  } finally {
    loading.value = false
  }
}

// 刷新数据
const refreshData = async () => {
  await fetchStatistics()
  ElMessage.success('数据已刷新')
}

// 处理分类点击
const handleCategoryClick = (data: ChartData) => {
  console.log('点击分类:', data)
  ElMessage.info(`点击了 "${data.name}" 分类`)
}

// 处理平台点击
const handlePlatformClick = (data: ChartData) => {
  console.log('点击平台:', data)
  ElMessage.info(`点击了 "${data.name}" 平台`)
}

// 处理状态点击
const handleStatusClick = (data: ChartData) => {
  console.log('点击状态:', data)
  ElMessage.info(`点击了 "${data.name}" 状态`)
}

// 处理月份点击
const handleMonthClick = (data: MonthlyData, seriesName: string) => {
  console.log('点击月份:', data, seriesName)
  ElMessage.info(`点击了 "${data.month}" 的 ${seriesName}`)
}

// 处理字数点击
const handleWordCountClick = (data: MonthlyData, seriesName: string) => {
  console.log('点击字数统计:', data, seriesName)
  ElMessage.info(`点击了 "${data.month}" 的 ${seriesName}`)
}

// 处理导出
const handleExport = async () => {
  if (exportForm.dataTypes.length === 0) {
    ElMessage.warning('请选择要导出的数据类型')
    return
  }

  exporting.value = true
  try {
    const exportOptions = {
      format: exportForm.format,
      dateRange: exportForm.dateRange.length === 2 ? {
        start: exportForm.dateRange[0],
        end: exportForm.dateRange[1]
      } : undefined,
      dataTypes: {
        books: exportForm.dataTypes.includes('books'),
        statistics: exportForm.dataTypes.includes('statistics'),
        charts: exportForm.dataTypes.includes('charts')
      }
    }

    const response = await statsApi.exportData(exportOptions)
    if (response.success && response.data) {
      ElMessage.success(`数据已导出到: ${response.data.fileName}`)
      showExportDialog.value = false
    } else {
      ElMessage.error(response.error || '导出失败')
    }
  } catch (error) {
    console.error('导出失败:', error)
    ElMessage.error('导出失败')
  } finally {
    exporting.value = false
  }
}

// 生命周期
onMounted(() => {
  fetchStatistics()
})
</script>

<style scoped>
.statistics {
  @apply p-6 space-y-6 max-w-7xl mx-auto;
}

/* 页面头部 */
.statistics__header {
  @apply flex items-center justify-between mb-8;
}

.statistics__title h1 {
  @apply text-3xl font-bold text-gray-900 mb-2;
}

.statistics__subtitle {
  @apply text-gray-600 text-lg;
}

/* 总体统计卡片区域 */
.statistics__overview {
  @apply grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 mb-8;
}

/* 图表区域 */
.statistics__charts {
  @apply space-y-8;
}

.statistics__chart-row {
  @apply grid grid-cols-1 lg:grid-cols-3 gap-6;
}

.statistics__chart-item {
  @apply bg-white rounded-lg shadow-sm border border-gray-100 p-6;
}

.statistics__chart-item--full {
  @apply lg:col-span-3;
}

/* 加载状态 */
.statistics__loading {
  @apply bg-white rounded-lg shadow-sm border border-gray-100 p-6;
}

/* 空状态 */
.statistics__empty {
  @apply flex items-center justify-center min-h-[400px] bg-white rounded-lg shadow-sm border border-gray-100;
}

.statistics__empty-tip {
  @apply text-sm text-gray-500 mt-2;
}

/* 导出对话框 */
.export-dialog__content {
  @apply space-y-4;
}

.export-dialog__footer {
  @apply flex justify-end space-x-3;
}

/* 响应式设计 */
@media (max-width: 1024px) {
  .statistics__overview {
    @apply grid-cols-1 sm:grid-cols-2 lg:grid-cols-3;
  }

  .statistics__chart-row {
    @apply grid-cols-1 lg:grid-cols-2;
  }

  .statistics__chart-item--full {
    @apply lg:col-span-2;
  }
}

@media (max-width: 768px) {
  .statistics {
    @apply p-4 space-y-4;
  }

  .statistics__header {
    @apply flex-col items-start space-y-4;
  }

  .statistics__overview {
    @apply grid-cols-1 sm:grid-cols-2;
  }

  .statistics__chart-row {
    @apply grid-cols-1;
  }

  .statistics__chart-item--full {
    @apply lg:col-span-1;
  }
}
</style>

